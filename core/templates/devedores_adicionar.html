{% extends 'base.html' %}
{% block content %}

<style>
  .form-container{max-width:900px;margin:0 auto;padding:1.5rem 1rem}
  .page-header{display:flex;flex-direction:column;gap:0.4rem;margin-bottom:1.5rem}
  .page-title{font-size:1.1rem;font-weight:600;color:#2d3748;display:flex;align-items:center;gap:0.5rem;margin:0}
  .page-subtitle{font-size:0.85rem;color:#6c757d}
  .card-section{background:#fff;border:1px solid #dee2e6;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:1.15rem;margin-bottom:1rem}
  .section-title{font-size:0.9rem;font-weight:600;color:#343a40;margin-bottom:0.8rem;display:flex;align-items:center;gap:0.4rem}
  .section-title i{color:#007bff}
  .form-label{font-size:0.78rem;color:#495057;font-weight:500}
  .form-label.required::after{content:" *";color:#dc3545}
  .form-control,.form-select,textarea{font-size:0.85rem;border-radius:6px;border:1px solid #ced4da;padding:0.45rem 0.6rem}
  .form-control:focus,.form-select:focus,textarea:focus{border-color:#007bff;box-shadow:0 0 0 0.15rem rgba(0,123,255,0.2)}
  .helper{font-size:0.75rem;color:#6c757d;margin-top:0.25rem}
  .btn{display:inline-flex;align-items:center;gap:0.4rem;font-weight:600;border-radius:4px;border:none;padding:0.55rem 1.1rem;font-size:0.9rem;text-decoration:none}
  .btn-primary{background:#007bff;color:#fff}
  .btn-primary:hover{background:#0056b3;color:#fff}
  .btn-success{background:#28a745;color:#fff}
  .btn-success:hover{background:#218838;color:#fff}
  .btn-outline{background:#fff;color:#495057;border:1px solid #dee2e6}
  .btn-outline:hover{background:#f8f9fa}
  textarea{resize:vertical;min-height:80px}
  .pessoa-juridica,.pessoa-fisica{transition:all 0.3s ease}
  .alert{border-radius:6px}
  @media (max-width:576px){
    .form-container{padding:1.25rem 0.75rem}
  }
</style>

<div class="form-container">
  <div class="page-header">
    <h1 class="page-title"><i class="fas fa-user-plus"></i>Adicionar Devedor</h1>
    <p class="page-subtitle">Preencha os dados necessários. A empresa é preenchida automaticamente pela sua sessão.</p>
  </div>

  {% if errors %}
    <div class="alert alert-danger">
      <strong>Por favor, corrija os seguintes campos:</strong>
      <ul class="mb-0">
        {% for k,v in errors.items %}
        <li>{{ v }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="POST" class="row g-3 needs-validation" novalidate onsubmit="return validarFormularioFinal();">
    {% csrf_token %}

    <div class="card-section">
      <div class="section-title"><i class="fas fa-link"></i>Vinculação</div>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label required">Empresa</label>
          <input type="text" id="empresa_display" class="form-control" value="{{ empresa_sessao.razao_social }}" readonly>
          <input type="hidden" name="empresa_id" id="empresa_id" value="{{ empresa_sessao.id }}">
          <div class="helper">A empresa é definida automaticamente pela sessão atual.</div>
        </div>
        <div class="col-md-6">
          <label for="tipo_pessoa" class="form-label required">Tipo de pessoa</label>
          <select name="tipo_pessoa" id="tipo_pessoa" class="form-select" required onchange="togglePessoaFields()">
            <option value="F" {% if initial_tipo == 'F' %}selected{% endif %}>Pessoa Física</option>
            <option value="J" {% if initial_tipo == 'J' %}selected{% endif %}>Pessoa Jurídica</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card-section">
      <div class="section-title"><i class="fas fa-id-card"></i>Identificação</div>
      <div class="row g-3">
        <div class="col-md-6 pessoa-fisica">
          <label for="nome" class="form-label required">Nome completo</label>
          <input type="text" name="nome" id="nome" class="form-control" placeholder="Ex: João da Silva" value="{{ initial.nome }}">
        </div>
        <div class="col-md-6 pessoa-fisica">
          <label for="cpf" class="form-label required">CPF</label>
          <input type="text" name="cpf" id="cpf" class="form-control" maxlength="14" placeholder="000.000.000-00" oninput="formatarCPF(this)" onblur="validarCPF()" value="{{ initial.cpf }}">
          <small id="cpfError" class="text-danger" style="display:none;">CPF inválido</small>
        </div>
        <div class="col-md-6 pessoa-fisica">
          <label for="nome_mae" class="form-label">Nome da mãe</label>
          <input type="text" name="nome_mae" id="nome_mae" class="form-control" placeholder="Ex: Maria da Silva" value="{{ initial.nome_mae }}">
        </div>
        <div class="col-md-6 pessoa-fisica">
          <label for="rg" class="form-label">RG</label>
          <input type="text" name="rg" id="rg" class="form-control" placeholder="Ex: 12.345.678-9" value="{{ initial.rg }}">
        </div>

        <div class="col-md-6 pessoa-juridica" style="display:none;">
          <label for="razao_social" class="form-label required">Razão social</label>
          <input type="text" name="razao_social" id="razao_social" class="form-control" placeholder="Ex: Empresa XYZ Ltda" value="{{ initial.razao_social }}">
        </div>
        <div class="col-md-6 pessoa-juridica" style="display:none;">
          <label for="cnpj" class="form-label required">CNPJ</label>
          <input type="text" name="cnpj" id="cnpj" class="form-control" maxlength="18" placeholder="00.000.000/0000-00" oninput="formatarCNPJ(this)" onblur="validarCNPJ()" value="{{ initial.cnpj }}">
          <small id="cnpjError" class="text-danger" style="display:none;">CNPJ inválido</small>
        </div>
        <div class="col-md-6 pessoa-juridica" style="display:none;">
          <label for="nome_fantasia" class="form-label">Nome fantasia</label>
          <input type="text" name="nome_fantasia" id="nome_fantasia" class="form-control" placeholder="Ex: XYZ Comércio" value="{{ initial.nome_fantasia }}">
        </div>
        <div class="col-md-6 pessoa-juridica" style="display:none;">
          <label for="nome_socio" class="form-label">Nome do sócio</label>
          <input type="text" name="nome_socio" id="nome_socio" class="form-control" placeholder="Ex: João da Silva" value="{{ initial.nome_socio }}">
        </div>
        <div class="col-md-6 pessoa-juridica" style="display:none;">
          <label for="cpf_socio" class="form-label">CPF do sócio</label>
          <input type="text" name="cpf_socio" id="cpf_socio" class="form-control" maxlength="14" placeholder="000.000.000-00" oninput="formatarCPF(this)" onblur="validarCPFSocio()" value="{{ initial.cpf_socio }}">
          <small id="cpfSocioError" class="text-danger" style="display:none;">CPF do sócio inválido</small>
        </div>
        <div class="col-md-6 pessoa-juridica" style="display:none;">
          <label for="rg_socio" class="form-label">RG do sócio</label>
          <input type="text" name="rg_socio" id="rg_socio" class="form-control" placeholder="Ex: 12.345.678-9" value="{{ initial.rg_socio }}">
        </div>
      </div>
    </div>

    <div class="card-section">
      <div class="section-title"><i class="fas fa-map-marker-alt"></i>Endereço</div>
      <div class="row g-3">
        <div class="col-md-4">
          <label for="cep" class="form-label">CEP</label>
          <input type="text" name="cep" id="cep" class="form-control" placeholder="00000-000" onblur="buscarEndereco()" value="{{ initial.cep }}">
        </div>
        <div class="col-md-8">
          <label for="endereco" class="form-label">Endereço</label>
          <input type="text" name="endereco" id="endereco" class="form-control" placeholder="Ex: Rua das Flores, 123" value="{{ initial.endereco }}">
        </div>
        <div class="col-md-4">
          <label for="bairro" class="form-label">Bairro</label>
          <input type="text" name="bairro" id="bairro" class="form-control" placeholder="Ex: Centro" value="{{ initial.bairro }}">
        </div>
        <div class="col-md-2">
          <label for="uf" class="form-label">UF</label>
          <input type="text" name="uf" id="uf" class="form-control" placeholder="SP" maxlength="2" value="{{ initial.uf }}">
        </div>
        <div class="col-md-6">
          <label for="cidade" class="form-label">Cidade</label>
          <input type="text" name="cidade" id="cidade" class="form-control" placeholder="Ex: São Paulo" value="{{ initial.cidade }}">
        </div>
        <div class="col-12">
          <label for="observacao" class="form-label">Observações</label>
          <textarea name="observacao" id="observacao" class="form-control" rows="3" placeholder="Informações adicionais sobre o devedor...">{{ initial.observacao }}</textarea>
        </div>
      </div>
    </div>

    <div class="card-section">
      <div class="section-title"><i class="fas fa-phone"></i>Telefones e e-mails (opcionais)</div>
      <div class="row g-3">
        <div class="col-md-6"><label class="form-label" for="telefone1">Telefone 1</label><input type="text" id="telefone1" name="telefone1" class="form-control" placeholder="(00) 00000-0000" value="{{ initial.telefone1 }}"></div>
        <div class="col-md-6"><label class="form-label" for="telefone2">Telefone 2</label><input type="text" id="telefone2" name="telefone2" class="form-control" placeholder="(00) 00000-0000" value="{{ initial.telefone2 }}"></div>
        <div class="col-md-6"><label class="form-label" for="telefone3">Telefone 3</label><input type="text" id="telefone3" name="telefone3" class="form-control" placeholder="(00) 00000-0000" value="{{ initial.telefone3 }}"></div>
        <div class="col-md-6"><label class="form-label" for="telefone4">Telefone 4</label><input type="text" id="telefone4" name="telefone4" class="form-control" placeholder="(00) 00000-0000" value="{{ initial.telefone4 }}"></div>
        <div class="col-md-6"><label class="form-label" for="telefone5">Telefone 5</label><input type="text" id="telefone5" name="telefone5" class="form-control" placeholder="(00) 00000-0000" value="{{ initial.telefone5 }}"></div>
        <div class="col-md-6"><label class="form-label" for="telefone6">Telefone 6</label><input type="text" id="telefone6" name="telefone6" class="form-control" placeholder="(00) 00000-0000" value="{{ initial.telefone6 }}"></div>
        <div class="col-md-6"><label class="form-label" for="telefone7">Telefone 7</label><input type="text" id="telefone7" name="telefone7" class="form-control" placeholder="(00) 00000-0000" value="{{ initial.telefone7 }}"></div>
        <div class="col-md-6"><label class="form-label" for="telefone8">Telefone 8</label><input type="text" id="telefone8" name="telefone8" class="form-control" placeholder="(00) 00000-0000" value="{{ initial.telefone8 }}"></div>
        <div class="col-md-6"><label class="form-label" for="telefone9">Telefone 9</label><input type="text" id="telefone9" name="telefone9" class="form-control" placeholder="(00) 00000-0000" value="{{ initial.telefone9 }}"></div>
        <div class="col-md-6"><label class="form-label" for="telefone10">Telefone 10</label><input type="text" id="telefone10" name="telefone10" class="form-control" placeholder="(00) 00000-0000" value="{{ initial.telefone10 }}"></div>
        <div class="col-md-6"><label class="form-label" for="email1">E-mail 1</label><input type="email" id="email1" name="email1" class="form-control" placeholder="exemplo@email.com" value="{{ initial.email1 }}"></div>
        <div class="col-md-6"><label class="form-label" for="email2">E-mail 2</label><input type="email" id="email2" name="email2" class="form-control" placeholder="exemplo@email.com" value="{{ initial.email2 }}"></div>
      </div>
    </div>

    <div class="text-end">
      <button id="btnSalvar" type="submit" class="btn btn-success"><i class="fas fa-save"></i> Salvar devedor</button>
    </div>
  </form>
</div>

<script>
  // ViaCEP
  function buscarEndereco() {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    if (cep.length === 8) {
      fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(r => r.json())
        .then(data => {
          if (!data.erro) {
            document.getElementById('endereco').value = data.logradouro || '';
            document.getElementById('bairro').value   = data.bairro || '';
            document.getElementById('uf').value       = data.uf || '';
            document.getElementById('cidade').value   = data.localidade || '';
          } else { alert('CEP não encontrado.'); }
        })
        .catch(() => alert('Erro ao buscar o CEP. Tente novamente.'));
    } else if (cep.length && cep.length !== 8) {
      alert('CEP inválido. Certifique-se de que tenha 8 dígitos.');
    }
  }

  function togglePessoaFields() {
    const tipo = document.getElementById('tipo_pessoa').value;
    const pf = document.querySelectorAll('.pessoa-fisica');
    const pj = document.querySelectorAll('.pessoa-juridica');

    if (tipo === 'F') {
      pf.forEach(el=>el.style.display='block'); pj.forEach(el=>el.style.display='none');
      setRequiredPF(true); setRequiredPJ(false);
    } else {
      pf.forEach(el=>el.style.display='none'); pj.forEach(el=>el.style.display='block');
      setRequiredPF(false); setRequiredPJ(true);
    }
  }

  function setRequiredPF(isReq){
    const nome = document.getElementById('nome');
    const cpf  = document.getElementById('cpf');
    if (nome) nome.required = isReq;
    if (cpf)  cpf.required  = isReq;
  }
  function setRequiredPJ(isReq){
    const rz  = document.getElementById('razao_social');
    const cnpj= document.getElementById('cnpj');
    if (rz)   rz.required   = isReq;
    if (cnpj) cnpj.required = isReq;
  }

  function validarCPF(){
    const el=document.getElementById('cpf'), err=document.getElementById('cpfError');
    if(!el) return true;
    const dig=el.value.replace(/\D/g,'');
    if(!dig.length){ if(err) err.style.display='none'; return true; }
    const ok = (dig.length===11 && calculaCPF(dig));
    if(err) err.style.display = ok ? 'none' : 'block';
    if (ok) {
      buscarDadosCPF_Lemit(dig);
    }
    return ok;
  }
  function validarCNPJ(){
    const el=document.getElementById('cnpj'), err=document.getElementById('cnpjError');
    if(!el) return true;
    const dig=el.value.replace(/\D/g,'');
    if(!dig.length){ if(err) err.style.display='none'; return true; }
    const ok = (dig.length===14 && calculaCNPJ(dig));
    if(err) err.style.display = ok ? 'none' : 'block';
    return ok;
  }
  function validarCPFSocio(){
    const el=document.getElementById('cpf_socio'); if(!el) return true;
    const err=document.getElementById('cpfSocioError'), dig=el.value.replace(/\D/g,'');
    if(!dig.length){ if(err) err.style.display='none'; return true; }
    const ok = (dig.length===11 && calculaCPF(dig));
    if(err) err.style.display = ok ? 'none' : 'block';
    return ok;
  }

  function validarFormularioFinal() {
    const tipo = document.getElementById('tipo_pessoa').value;
    if (tipo === 'F' && !validarCPF()) { alert('CPF inválido.'); return false; }
    if (tipo === 'J' && !validarCNPJ()) { alert('CNPJ inválido.'); return false; }
    if (tipo === 'J' && !validarCPFSocio()) { /* não bloqueia */ }

    const btn=document.getElementById('btnSalvar');
    if(btn){ btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Salvando...'; }
    return true;
  }

  function calculaCPF(cpf){
    let soma=0, resto; if(/^(\d)\1+$/.test(cpf)) return false;
    for(let i=1;i<=9;i++) soma += parseInt(cpf[i-1])*(11-i);
    resto=(soma*10)%11; if(resto===10||resto===11) resto=0;
    if(resto!==parseInt(cpf[9])) return false;
    soma=0; for(let i=1;i<=10;i++) soma += parseInt(cpf[i-1])*(12-i);
    resto=(soma*10)%11; if(resto===10||resto===11) resto=0;
    return resto===parseInt(cpf[10]);
  }
  function calculaCNPJ(cnpj){
    let t=cnpj.length-2, n=cnpj.substring(0,t), d=cnpj.substring(t), s=0, p=t-7;
    for(let i=t;i>=1;i--){ s+=n.charAt(t-i)*p--; if(p<2) p=9; }
    let r=s%11<2?0:11-(s%11);
    if(r!==parseInt(d.charAt(0))) return false;
    t++; n=cnpj.substring(0,t); s=0; p=t-7;
    for(let i=t;i>=1;i--){ s+=n.charAt(t-i)*p--; if(p<2) p=9; }
    r=s%11<2?0:11-(s%11);
    return r===parseInt(d.charAt(1));
  }
  function formatarCPF(campo){
    let v=campo.value.replace(/\D/g,'');
    if(v.length>11) v=v.substring(0,11);
    campo.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, "$1.$2.$3-$4");
  }
  function formatarCNPJ(campo){
    let v=campo.value.replace(/\D/g,'');
    if(v.length>14) v=v.substring(0,14);
    campo.value = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, "$1.$2.$3/$4-$5");
  }

  function buscarDadosCPF_Lemit(cpfNumerico){
    if (!cpfNumerico || cpfNumerico.length !== 11) return;

    fetch(`/api/devedores/buscar-por-cpf/?cpf=${cpfNumerico}`)
      .then(r => r.json())
      .then(data => {
        if (data.erro) {
          console.warn('Erro Lemit:', data.erro);
          return;
        }

        if (data.nome) {
          const nomeEl = document.getElementById('nome');
          if (nomeEl && !nomeEl.value) nomeEl.value = data.nome;
        }
        if (data.nome_mae) {
          const maeEl = document.getElementById('nome_mae');
          if (maeEl && !maeEl.value) maeEl.value = data.nome_mae;
        }
        if (data.cep) {
          const cepEl = document.getElementById('cep');
          if (cepEl && !cepEl.value) cepEl.value = data.cep;
        }
        if (data.endereco) {
          const endEl = document.getElementById('endereco');
          if (endEl && !endEl.value) endEl.value = data.endereco;
        }
        if (data.bairro) {
          const bairroEl = document.getElementById('bairro');
          if (bairroEl && !bairroEl.value) bairroEl.value = data.bairro;
        }
        if (data.cidade) {
          const cidadeEl = document.getElementById('cidade');
          if (cidadeEl && !cidadeEl.value) cidadeEl.value = data.cidade;
        }
        if (data.uf) {
          const ufEl = document.getElementById('uf');
          if (ufEl && !ufEl.value) ufEl.value = data.uf;
        }

        if (Array.isArray(data.telefones)) {
          for (let i = 0; i < 10; i++) {
            const telVal = data.telefones[i];
            const telEl = document.getElementById(`telefone${i+1}`);
            if (telEl && telVal && !telEl.value) {
              telEl.value = telVal;
            }
          }
        }

        if (Array.isArray(data.emails)) {
          const email1 = document.getElementById('email1');
          const email2 = document.getElementById('email2');
          if (email1 && data.emails[0] && !email1.value) email1.value = data.emails[0];
          if (email2 && data.emails[1] && !email2.value) email2.value = data.emails[1];
        }
      })
      .catch(err => {
        console.error('Erro ao consultar Lemit:', err);
      });
  }

  document.addEventListener('DOMContentLoaded', function(){
    togglePessoaFields();
  });
</script>

{% endblock %}

{% extends 'base.html' %}

{% block content %}
<style>
/* ========== RESET E ESTILOS GERAIS ========== */
* {
    box-sizing: border-box;
}

html, body {
    width: 100%;
    overflow-x: hidden;
}

body {
    background: #f8f9fa;
    margin: 0;
    padding: 0;
}

/* ========== CARDS DE ESTATÍSTICAS ========== */
.dashboard-card {
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    overflow: hidden;
    position: relative;
    background: white;
    min-height: 100px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

.dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: #495057;
}

.card-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    position: relative;
    z-index: 1;
    min-height: 100px;
}

.card-info {
    flex: 1;
    min-width: 0;
}

.card-title {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #6c757d;
    letter-spacing: 0.3px;
    text-transform: uppercase;
}

.card-value {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    line-height: 1.2;
    color: #212529;
    word-break: break-word;
}

.card-icon {
    font-size: 2.5rem;
    opacity: 0.15;
    color: #495057;
    flex-shrink: 0;
    margin-left: 0.5rem;
}

/* Cores profissionais para os cards */
.card-gradient-1 {
    background: white;
}
.card-gradient-1::before {
    background: #007bff;
}

.card-gradient-2 {
    background: white;
}
.card-gradient-2::before {
    background: #28a745;
}

.card-gradient-3 {
    background: white;
}
.card-gradient-3::before {
    background: #ffc107;
}

.card-gradient-4 {
    background: white;
}
.card-gradient-4::before {
    background: #dc3545;
}

.card-gradient-5 {
    background: white;
}
.card-gradient-5::before {
    background: #fd7e14;
}

.card-gradient-6 {
    background: white;
}
.card-gradient-6::before {
    background: #17a2b8;
}

.card-gradient-7 {
    background: white;
}
.card-gradient-7::before {
    background: #6c757d;
}

/* ========== CAMPO DE BUSCA ========== */
.search-container {
    margin: 1.5rem 0;
    width: 100%;
}

.search-form {
    position: relative;
    width: 100%;
}

.search-wrapper {
    background: white;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    padding: 0.25rem;
    display: flex;
    align-items: center;
    width: 100%;
    flex-wrap: nowrap;
    gap: 0.25rem;
}

.search-wrapper:focus-within {
    border-color: #007bff;
    box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.25);
}

.search-icon {
    padding: 0.4rem 0.6rem;
    color: #6c757d;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.search-input {
    flex: 1;
    border: none;
    outline: none;
    padding: 0.4rem 0.6rem;
    font-size: 0.875rem;
    background: transparent;
    min-width: 0;
    width: 100%;
}

.search-input::placeholder {
    color: #adb5bd;
}

.search-btn {
    background: #007bff;
    border: none;
    border-radius: 4px;
    padding: 0.4rem 1rem;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
}

.search-btn:hover {
    background: #0056b3;
}

.search-btn i {
    display: inline-block;
}

/* ========== TÍTULOS DAS SEÇÕES ========== */
.section-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: #2d3748;
    margin: 1.25rem 0 0.75rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-title i {
    color: #495057;
    font-size: 0.9rem;
}

.section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #dee2e6;
    margin-left: 1rem;
}

/* Mensagens de "nenhum item encontrado" */
.text-muted {
    font-size: 0.8rem;
    color: #6c757d;
}

.text-muted.small {
    font-size: 0.75rem;
}

/* ========== TABELAS ========== */
.table-container {
    background: white;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 2rem;
    width: 100%;
}

.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    display: block;
}

.custom-table {
    width: 100%;
    margin: 0;
    font-size: 0.8rem;
    min-width: 600px;
}

.custom-table thead {
    background: #495057;
    color: white;
}

.custom-table thead th {
    padding: 0.6rem 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.3px;
    border: none;
    white-space: nowrap;
}

.custom-table tbody tr {
    border-bottom: 1px solid #f1f3f5;
}

.custom-table tbody tr:hover {
    background: #f8f9fa;
}

.custom-table tbody td {
    padding: 0.6rem 0.75rem;
    vertical-align: middle;
    border: none;
    white-space: nowrap;
    font-size: 0.8rem;
}

.custom-table tbody td b {
    font-weight: 600;
    font-size: 0.8rem;
}

/* Estilos para células de ações que podem ter quebra */
.custom-table tbody td.text-center {
    white-space: normal;
}

.custom-table tbody td .btn-action {
    white-space: nowrap;
    display: inline-block;
    margin: 0.1rem;
    padding: 0.35rem 0.65rem;
    font-size: 0.75rem;
}

/* ========== BOTÕES ========== */
.btn-action {
    padding: 0.4rem 0.75rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    border: none;
    margin: 0.1rem;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-info:hover {
    background: #138496;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
    color: white;
}

/* ========== PAGINAÇÃO ========== */
.pagination {
    margin: 1.5rem 0;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.25rem;
}

.page-item {
    list-style: none;
    margin: 0;
}

.page-link {
    display: inline-block;
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    font-weight: 500;
    color: #495057;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    text-decoration: none;
    transition: all 0.15s ease;
    min-width: 38px;
    text-align: center;
}

.page-link:hover {
    color: #007bff;
    background-color: #f8f9fa;
    border-color: #007bff;
    text-decoration: none;
}

.page-link:focus {
    box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.1);
    outline: none;
}

.page-item.active .page-link {
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
    cursor: default;
}

.page-item.active .page-link:hover {
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
}

.page-item.disabled .page-link {
    color: #6c757d;
    background-color: #fff;
    border-color: #dee2e6;
    cursor: not-allowed;
    opacity: 0.6;
}

.page-item.disabled .page-link:hover {
    color: #6c757d;
    background-color: #fff;
    border-color: #dee2e6;
}

.page-item.disabled .page-link {
    cursor: default;
}

/* Estilo para os três pontos na paginação */
.page-item.disabled .page-link.ellipsis {
    border: none;
    background-color: transparent;
    padding: 0.5rem 0.25rem;
    min-width: auto;
    opacity: 1;
}

.page-item.disabled .page-link.ellipsis:hover {
    background-color: transparent;
    border: none;
}

/* ========== RESPONSIVIDADE ========== */
@media (max-width: 768px) {
    .dashboard-card {
        min-height: 90px;
    }
    
    .card-content {
        padding: 0.875rem 1rem;
        min-height: 90px;
    }
    
    .card-title {
        font-size: 0.7rem;
        margin-bottom: 0.4rem;
    }
    
    .card-value {
        font-size: 1.5rem;
    }
    
    .card-icon {
        font-size: 2rem;
        margin-left: 0.4rem;
    }
    
    .section-title {
        font-size: 0.9rem;
        margin: 1rem 0 0.75rem 0;
    }
    
    .section-title i {
        font-size: 0.85rem;
    }
    
    .text-muted {
        font-size: 0.75rem;
    }
    
    .text-muted.small {
        font-size: 0.7rem;
    }
    
    .search-btn {
        padding: 0.4rem 1rem;
        font-size: 0.8rem;
    }
    
    .custom-table {
        font-size: 0.75rem;
        min-width: 500px;
    }
    
    .custom-table thead th {
        padding: 0.5rem 0.4rem;
        font-size: 0.65rem;
    }
    
    .custom-table tbody td {
        padding: 0.5rem 0.4rem;
        font-size: 0.75rem;
    }
    
    .custom-table tbody td b {
        font-size: 0.75rem;
    }
    
    .custom-table tbody td .btn-action {
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
        margin: 0.05rem;
    }
    
    .pagination {
        margin: 1.25rem 0;
        gap: 0.2rem;
    }
    
    .page-link {
        padding: 0.45rem 0.65rem;
        font-size: 0.75rem;
        min-width: 34px;
    }
    
    .container {
        padding: 1rem 0.75rem;
    }
}

@media (max-width: 576px) {
    .dashboard-card {
        min-height: 85px;
        margin-bottom: 0.75rem;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    .card-content {
        padding: 0.75rem 1rem;
        min-height: 85px;
        flex-direction: row;
        align-items: center;
        width: 100%;
        box-sizing: border-box;
    }
    
    .card-info {
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }
    
    .card-icon {
        font-size: 1.75rem;
        margin-left: 0.5rem;
        opacity: 0.12;
        flex-shrink: 0;
    }
    
    .card-title {
        font-size: 0.65rem;
        margin-bottom: 0.3rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .card-value {
        font-size: 1.3rem;
        word-break: break-word;
        overflow-wrap: break-word;
    }
    
    .search-wrapper {
        flex-wrap: nowrap;
        gap: 0.25rem;
    }
    
    .search-icon {
        padding: 0.4rem 0.5rem;
        font-size: 0.85rem;
        flex-shrink: 0;
    }
    
    .search-input {
        flex: 1;
        min-width: 0;
        padding: 0.4rem 0.5rem;
        font-size: 0.8rem;
    }
    
    .search-btn {
        flex-shrink: 0;
        min-width: 100px;
        font-size: 0.8rem;
        padding: 0.4rem 0.75rem;
        white-space: nowrap;
    }
    
    .search-btn span {
        display: none;
    }
    
    .search-btn i.me-2 {
        margin-right: 0 !important;
    }
    
    .section-title {
        font-size: 0.85rem;
        margin: 0.75rem 0 0.5rem 0;
        gap: 0.4rem;
    }
    
    .section-title i {
        font-size: 0.8rem;
    }
    
    .section-title::after {
        display: none;
    }
    
    .text-muted {
        font-size: 0.7rem;
    }
    
    .text-muted.small {
        font-size: 0.65rem;
    }
    
    .container {
        padding: 1rem 0.5rem;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    .row {
        margin-bottom: 1rem;
        margin-left: 0;
        margin-right: 0;
        width: 100%;
    }
    
    .row.g-4 {
        --bs-gutter-x: 0.75rem;
        --bs-gutter-y: 0.75rem;
    }
    
    .row.g-4 > * {
        padding-left: calc(var(--bs-gutter-x) * 0.5);
        padding-right: calc(var(--bs-gutter-x) * 0.5);
    }
    
    .col-12 {
        flex: 0 0 100%;
        max-width: 100%;
        width: 100%;
    }
    
    .table-container {
        border-radius: 6px;
        margin-bottom: 1.5rem;
    }
    
    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
    }
    
    .custom-table {
        min-width: 500px;
        font-size: 0.7rem;
    }
    
    .custom-table thead th {
        padding: 0.4rem 0.35rem;
        font-size: 0.6rem;
    }
    
    .custom-table tbody td {
        padding: 0.4rem 0.35rem;
        font-size: 0.7rem;
    }
    
    .custom-table tbody td b {
        font-size: 0.7rem;
    }
    
    .custom-table tbody td .btn-action {
        padding: 0.25rem 0.4rem;
        font-size: 0.65rem;
        margin: 0.05rem;
        display: inline-block;
    }
    
    .pagination {
        margin: 1rem 0;
        gap: 0.15rem;
    }
    
    .page-link {
        padding: 0.4rem 0.55rem;
        font-size: 0.7rem;
        min-width: 32px;
    }
    
    .page-link i {
        font-size: 0.65rem;
    }
    
    /* Adiciona indicador visual de scroll horizontal */
    .table-wrapper::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 30px;
        background: linear-gradient(to right, transparent, rgba(255,255,255,0.8));
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .table-wrapper:hover::after {
        opacity: 1;
    }
}


/* ========== ESPAÇAMENTOS ========== */
.container {
    max-width: 1400px;
    padding: 2rem 1rem;
}

.row {
    margin-bottom: 1.5rem;
}

.row.g-4 > * {
    padding-right: calc(var(--bs-gutter-x) * 0.5);
    padding-left: calc(var(--bs-gutter-x) * 0.5);
}

/* Garantir que os cards não quebrem */
.col-12,
.col-sm-6,
.col-md-6,
.col-lg-3 {
    width: 100%;
    max-width: 100%;
    flex: 0 0 100%;
}

@media (min-width: 576px) {
    .col-sm-6 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

@media (min-width: 768px) {
    .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

@media (min-width: 992px) {
    .col-lg-3 {
        flex: 0 0 25%;
        max-width: 25%;
    }
    
    .search-btn span {
        display: inline;
    }
    
    .search-btn i.me-2 {
        margin-right: 0.5rem !important;
    }
}

</style>

<div class="container">
    <div class="row g-4">
        <!-- Card Pendentes -->
        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
            <div class="card dashboard-card card-gradient-1 shadow-sm">
                <div class="card-content">
                    <div class="card-info">
                        <h6 class="card-title">Pendentes</h6>
                        <p class="card-value count-number mb-0" data-count="{{ titulos_pendentes }}">0</p>
                    </div>
                    <i class="fas fa-file-alt card-icon"></i>
                </div>
            </div>
        </div>

        <!-- Card Quitados -->
        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
            <div class="card dashboard-card card-gradient-2 shadow-sm">
                <div class="card-content">
                    <div class="card-info">
                        <h6 class="card-title">Quitados</h6>
                        <p class="card-value count-number mb-0" data-count="{{ titulos_quitados }}">0</p>
                    </div>
                    <i class="fas fa-check-circle card-icon"></i>
                </div>
            </div>
        </div>

        <!-- Card Negociados -->
        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
            <div class="card dashboard-card card-gradient-3 shadow-sm">
                <div class="card-content">
                    <div class="card-info">
                        <h6 class="card-title">Negociados</h6>
                        <p class="card-value count-number mb-0" data-count="{{ titulos_negociados }}">0</p>
                    </div>
                    <i class="fas fa-handshake card-icon"></i>
                </div>
            </div>
        </div>

        <!-- Card Total de Clientes -->
        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
            <div class="card dashboard-card card-gradient-4 shadow-sm">
                <div class="card-content">
                    <div class="card-info">
                        <h6 class="card-title">Total de Clientes</h6>
                        <p class="card-value count-number mb-0" data-count="{{ total_clientes }}">0</p>
                    </div>
                    <i class="fas fa-users card-icon"></i>
                </div>
            </div>
        </div>

        <!-- Card Negociados em Atraso -->
        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
            <div class="card dashboard-card card-gradient-5 shadow-sm">
                <div class="card-content">
                    <div class="card-info">
                        <h6 class="card-title">Negociados em Atraso</h6>
                        <p class="card-value count-number mb-0" data-count="{{ negociados_em_atraso_count }}">0</p>
                    </div>
                    <i class="fas fa-exclamation-circle card-icon"></i>
                </div>
            </div>
        </div>

        <!-- Card Quitados Hoje -->
        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
            <div class="card dashboard-card card-gradient-6 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalQuitadosHoje">
                <div class="card-content">
                    <div class="card-info">
                        <h6 class="card-title">Quitados Hoje</h6>
                        <p class="card-value mb-0">R$ {{ quitados_hoje|floatformat:2 }}</p>
                    </div>
                    <i class="fas fa-check-circle card-icon"></i>
                </div>
            </div>
        </div>

        <!-- Card Negociados Hoje -->
        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
            <div class="card dashboard-card card-gradient-7 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalNegociadosHoje">
                <div class="card-content">
                    <div class="card-info">
                        <h6 class="card-title">Negociados Hoje</h6>
                        <p class="card-value mb-0">R$ {{ negociados_hoje|floatformat:2 }}</p>
                    </div>
                    <i class="fas fa-handshake card-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Script para contagem animada -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const counters = document.querySelectorAll('.count-number');
        counters.forEach(counter => {
            const target = Number(counter.getAttribute('data-count') || 0);
            const updateCount = () => {
                const current = Number(counter.innerText) || 0;
                const increment = Math.max(1, Math.ceil(target / 100));
                if (current < target) {
                    counter.innerText = Math.min(current + increment, target);
                    setTimeout(updateCount, 20);
                } else {
                    counter.innerText = target;
                }
            };
            updateCount();
        });
    });
    </script>

    <!-- Modal para Quitados Hoje -->
    <div class="modal fade" id="modalQuitadosHoje" tabindex="-1" aria-labelledby="modalQuitadosHojeLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalQuitadosHojeLabel">Detalhes dos Quitados Hoje</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if quitados_hoje_detalhes %}
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>CPF/CNPJ</th>
                                    <th>Empresa</th>
                                    <th>Data de Baixa</th>
                                    <th>Valor Recebido</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in quitados_hoje_detalhes %}
                                    <tr>
                                        <td>{{ item.nome }}</td>
                                        <td>{{ item.cpf_cnpj }}</td>
                                        <td>{{ item.nome_fantasia }}</td>
                                        <td>{{ item.data_baixa }}</td>
                                        <td>{{ item.valorRecebido }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>Não há títulos quitados hoje.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById('modalQuitadosHoje');
        modal.addEventListener('show.bs.modal', function () {
            const modalBody = modal.querySelector('.modal-body');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';

            // Dados do contexto do Django (string JSON segura)
            const quitadosHojeDetalhes = JSON.parse('{{ quitados_hoje_detalhes|escapejs }}');

            if (quitadosHojeDetalhes.length > 0) {
                let htmlContent = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF/CNPJ</th>
                                <th>Empresa</th>
                                <th>Data de Baixa</th>
                                <th>Valor Recebido</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                quitadosHojeDetalhes.forEach(item => {
                    htmlContent += `
                        <tr>
                            <td>${item.nome}</td>
                            <td>${item.cpf_cnpj || 'Não informado'}</td>
                            <td>${item.nome_fantasia}</td>
                            <td>${item.data_baixa}</td>
                            <td>${item.valorRecebido}</td>
                        </tr>
                    `;
                });
                htmlContent += '</tbody></table>';
                modalBody.innerHTML = htmlContent;
            } else {
                modalBody.innerHTML = '<p>Não há títulos quitados hoje.</p>';
            }
        });
    });
    </script>

    <!-- Modal para Negociados Hoje -->
    <div class="modal fade" id="modalNegociadosHoje" tabindex="-1" aria-labelledby="modalNegociadosHojeLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNegociadosHojeLabel">Detalhes dos Negociados Hoje</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if negociados_hoje_detalhes %}
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>CPF/CNPJ</th>
                                    <th>Empresa</th>
                                    <th>Data de Negociação</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in negociados_hoje_detalhes %}
                                    <tr>
                                        <td>{{ item.nome }}</td>
                                        <td>{{ item.cpf_cnpj }}</td>
                                        <td>{{ item.nome_fantasia }}</td>
                                        <td>{{ item.data_negociacao }}</td>
                                        <td>{{ item.valor }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>Não há títulos negociados hoje.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const modalNegociadosHoje = document.getElementById('modalNegociadosHoje');
        modalNegociadosHoje.addEventListener('show.bs.modal', function () {
            const modalBody = modalNegociadosHoje.querySelector('.modal-body');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';

            const negociadosHojeDetalhes = JSON.parse('{{ negociados_hoje_detalhes|escapejs }}');
            if (negociadosHojeDetalhes.length > 0) {
                let htmlContent = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF/CNPJ</th>
                                <th>Empresa</th>
                                <th>Data de Negociação</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                negociadosHojeDetalhes.forEach(item => {
                    htmlContent += `
                        <tr>
                            <td>${item.nome}</td>
                            <td>${item.cpf_cnpj || 'Não informado'}</td>
                            <td>${item.nome_fantasia}</td>
                            <td>${item.data_negociacao}</td>
                            <td>${item.valor}</td>
                        </tr>
                    `;
                });
                htmlContent += '</tbody></table>';
                modalBody.innerHTML = htmlContent;
            } else {
                modalBody.innerHTML = '<p>Não há títulos negociados hoje.</p>';
            }
        });
    });
    </script>

    <!-- Busca -->
    <div class="search-container">
        <form method="get" action="{% url 'dashboard' %}" class="search-form">
            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" name="query" class="search-input" placeholder="Buscar por nome, CPF, CNPJ, Nome Fantasia..." value="{{ query }}">
                <button type="submit" class="search-btn">
                    <i class="fas fa-search me-2"></i> <span>Buscar</span>
            </button>
        </div>
    </form>
    </div>

    <!-- Agenda de trabalho do dia - Pendentes -->
    <h2 class="section-title"><i class="fas fa-calendar-day"></i>Agenda de trabalho do dia - Pendentes</h2>
    <div class="table-container">
        <div class="table-wrapper">
            <table class="custom-table">
                <thead>
            <tr>
                <th>Devedor</th>
                <th>Credor</th>
                <th>Nome da Mãe</th>
                <th>CPF/CNPJ</th>
                <th class="text-center">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for item in agenda_pendentes_paginated %}
            <tr>
                <td><b>{{ item.nome }}</b></td>
                <td><b>{{ item.nome_fantasia_credor }}</b></td>
                <td><b>{{ item.nome_mae }}</b></td>
                <td><b>
                    {% if item.cpf %}
                        {{ item.cpf }}
                    {% elif item.cnpj %}
                        {{ item.cnpj }}
                    {% else %}
                        Não informado
                    {% endif %}
                    </b>
                </td>
                <td class="text-center">
                            <a href="{% url 'detalhes_devedor' item.id %}" target="_blank" class="btn-action btn-info">Visualizar</a>
                            <a href="{% url 'realizar_baixa' item.id %}" class="btn-action btn-success">Baixar</a>
                    <button type="button"
                                    class="btn-action btn-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#modalFollowUps"
                            data-devedor="{{ item.devedor_id }}"
                            data-nome="{{ item.nome|escape }}">
                      Follow-ups
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
        </div>
    </div>

    <!-- Agendamentos pendentes -->
    <h2 class="section-title"><i class="fas fa-clock"></i>Agendamentos pendentes</h2>
    {% if agendamentos_hoje %}
    <div class="table-container">
        <div class="table-wrapper">
            <table class="custom-table">
                <thead>
            <tr>
                <th>Devedor</th>
                <th>CPF / CNPJ</th>
                <th>Empresa</th>
                <th>Telefone</th>
                <th>Data de Retorno</th>
                <th>Operador</th>
                <th class="text-center">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for agendamento in agendamentos_hoje %}
            <tr>
                <td><b>{{ agendamento.devedor__nome }}</b></td>
                <td><b>
                    {% if agendamento.devedor__cpf %}
                        {{ agendamento.devedor__cpf }}
                    {% elif agendamento.devedor__cnpj %}
                        {{ agendamento.devedor__cnpj }}
                    {% else %}
                        Não informado
                    {% endif %}
                </b></td>
                <td><b>{{ agendamento.empresa__nome_fantasia }}</b></td>
                <td class="text-center"><b>
                    {% if agendamento.telefone_formatado %}
                        <a href="https://wa.me/{{ agendamento.telefone_formatado }}" target="_blank" class="btn btn-success d-flex align-items-center">
                            <i class="fab fa-whatsapp me-2"></i>
                            {{ agendamento.telefone_formatado }}
                        </a>
                    {% endif %}
                </b></td>
                <td><b>{{ agendamento.data_retorno|date:"d/m/Y H:i" }}</b></td>
                <td><b>{{ agendamento.operador }}</b></td>
                <td class="text-center">
                    <button type="button" class="btn-action btn-info" data-bs-toggle="modal" data-bs-target="#modalAgendamento{{ agendamento.id }}">
                        Visualizar
                    </button>
                    <button type="button"
                            class="btn-action btn-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#modalFollowUps"
                            data-devedor="{{ agendamento.devedor_id }}"
                            data-nome="{{ agendamento.devedor__nome|escape }}">
                      Follow-ups
                    </button>
                </td>
            </tr>

            <!-- Modal Agendamento (existente) -->
            <div class="modal fade" id="modalAgendamento{{ agendamento.id }}" tabindex="-1" aria-labelledby="modalLabel{{ agendamento.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="modalLabel{{ agendamento.id }}">Detalhes do Agendamento</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Devedor:</strong> {{ agendamento.devedor__nome }}</p>
                            <p><strong>CPF:</strong> {{ agendamento.devedor__cpf|default:"Não informado" }}</p>
                            <p><strong>Empresa:</strong> {{ agendamento.empresa__nome_fantasia }}</p>
                            <p><strong>Telefone:</strong> {{ agendamento.telefone|default:"Não informado" }}</p>
                            <p><strong>Data de Abertura:</strong> {{ agendamento.data_abertura|date:"d/m/Y H:i" }}</p>
                            <p><strong>Data de Retorno:</strong> {{ agendamento.data_retorno|date:"d/m/Y H:i" }}</p>
                            <p><strong>Operador:</strong> {{ agendamento.operador }}</p>
                            <p><strong>Status:</strong>
                                <span class="badge {% if agendamento.status == 'Finalizado' %}bg-success{% else %}bg-warning text-dark{% endif %}">
                                    {{ agendamento.status }}
                                </span>
                            </p>
                            <p><strong>Assunto:</strong> {{ agendamento.assunto|default:"Não informado" }}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </tbody>
    </table>
        </div>
    </div>
    {% else %}
    <p class="text-muted small">Nenhum agendamento para hoje.</p>
    {% endif %}

    <!-- Negociados em atraso -->
    <h2 class="section-title"><i class="fas fa-exclamation-triangle"></i>Negociados em atraso</h2>
    {% if negociados_paginated %}
    <div class="table-container">
        <div class="table-wrapper">
            <table class="custom-table">
        <thead>
            <tr>
                <th>Devedor</th>
                <th>Empresa</th>
                <th>Data de Vencimento</th>
                <th>Valor</th>
                <th>Status</th>
                <th class="text-center">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for titulo in negociados_paginated %}
            <tr>
                <td>{{ titulo.devedor_nome }}</td>
                <td>{{ titulo.empresa_nome }}</td>
                <td>{{ titulo.data_vencimento|date:"d/m/Y" }}</td>
                <td>R$ {{ titulo.valor_total|floatformat:2 }}</td>
                <td><span class="badge bg-warning">Negociado em atraso</span></td>
                <td class="text-center">
                    <a href="{% url 'detalhes_devedor' titulo.id %}" target="_blank" class="btn-action btn-info">Visualizar</a>
                    <button type="button"
                            class="btn-action btn-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#modalFollowUps"
                            data-devedor="{{ titulo.devedor_id }}"
                            data-nome="{{ titulo.devedor_nome|escape }}">
                      Follow-ups
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
        </div>
    </div>

    <!-- Paginação -->
    <nav aria-label="Paginação de negociados em atraso">
        <ul class="pagination">
                {% if negociados_paginated.has_previous %}
                <li class="page-item">
                <a class="page-link" href="?page_negociados={{ negociados_paginated.previous_page_number }}" aria-label="Página anterior">
                    <i class="fas fa-chevron-left"></i> <span class="d-none d-sm-inline">Anterior</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-chevron-left"></i> <span class="d-none d-sm-inline">Anterior</span>
                </span>
                </li>
                {% endif %}

            {% if negociados_paginated.paginator.num_pages <= 7 %}
                {% for num in negociados_paginated.paginator.page_range %}
                    {% if negociados_paginated.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% else %}
                <li class="page-item">
                        <a class="page-link" href="?page_negociados={{ num }}">{{ num }}</a>
                </li>
                    {% endif %}
                {% endfor %}
            {% else %}
                {% if negociados_paginated.number > 3 %}
                <li class="page-item">
                    <a class="page-link" href="?page_negociados=1">1</a>
                </li>
                {% if negociados_paginated.number > 4 %}
                <li class="page-item disabled">
                    <span class="page-link ellipsis">...</span>
                </li>
                {% endif %}
                {% endif %}

                {% for num in negociados_paginated.paginator.page_range %}
                    {% if num >= negociados_paginated.number|add:'-2' and num <= negociados_paginated.number|add:'2' %}
                        {% if negociados_paginated.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page_negociados={{ num }}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if negociados_paginated.number < negociados_paginated.paginator.num_pages|add:'-2' %}
                {% if negociados_paginated.number < negociados_paginated.paginator.num_pages|add:'-3' %}
                <li class="page-item disabled">
                    <span class="page-link ellipsis">...</span>
                </li>
                {% endif %}
                <li class="page-item">
                    <a class="page-link" href="?page_negociados={{ negociados_paginated.paginator.num_pages }}">{{ negociados_paginated.paginator.num_pages }}</a>
                </li>
                {% endif %}
            {% endif %}

                {% if negociados_paginated.has_next %}
                <li class="page-item">
                <a class="page-link" href="?page_negociados={{ negociados_paginated.next_page_number }}" aria-label="Próxima página">
                    <span class="d-none d-sm-inline">Próxima </span><i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">
                    <span class="d-none d-sm-inline">Próxima </span><i class="fas fa-chevron-right"></i>
                </span>
                </li>
                {% endif %}
            </ul>
        </nav>
    {% else %}
    <p class="text-muted">Nenhum título negociado em atraso encontrado.</p>
    {% endif %}

    <!-- (Os modais de parcela/baixa que você tinha podem permanecer aqui, se aplicáveis ao contexto) -->

    <!-- Últimos clientes cadastrados -->
    <h2 class="section-title"><i class="fas fa-users"></i>Últimos Clientes Cadastrados</h2>
    <div class="table-container">
        <div class="table-wrapper">
            <table class="custom-table">
                <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>CPF/CNPJ</th>
                <th>Data de Cadastro</th>
            </tr>
        </thead>
        <tbody>
            {% for cliente in ultimos_clientes %}
            <tr>
                <td><b>{{ cliente.id }}</b></td>
                <td><b>{{ cliente.nome }}</b></td>
                <td><b>{% if cliente.cpf %}{{ cliente.cpf }}{% elif cliente.cnpj %}{{ cliente.cnpj }}{% else %}Não informado{% endif %}</b></td>
                <td><b>{{ cliente.created_at|date:"d/m/Y" }}</b></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
        </div>
    </div>
</div>

<!-- ================== MODAL REUTILIZÁVEL DE FOLLOW-UPS ================== -->
<div class="modal fade" id="modalFollowUps" tabindex="-1" aria-labelledby="modalFollowUpsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="modalFollowUpsLabel">Follow-ups</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="fuLoading" class="text-center py-4">
          <div class="spinner-border" role="status"></div>
          <div class="small mt-2">Carregando…</div>
        </div>
        <ul id="fuList" class="list-group d-none"></ul>
        <div id="fuEmpty" class="alert alert-light border d-none">Nenhum follow-up para este devedor.</div>
      </div>
      <div class="modal-footer">
        <button id="fuVerMais" type="button" class="btn btn-outline-secondary d-none">Ver mais</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const modal = document.getElementById('modalFollowUps');
  const fuList = document.getElementById('fuList');
  const fuLoading = document.getElementById('fuLoading');
  const fuEmpty = document.getElementById('fuEmpty');
  const fuVerMais = document.getElementById('fuVerMais');

  let currentDevedor = null;
  let currentLimit = 50;

  function escapeHTML(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');}

  async function loadFollowUps(devedorId, limit){
    fuLoading.classList.remove('d-none');
    fuList.classList.add('d-none');
    fuEmpty.classList.add('d-none');
    fuVerMais.classList.add('d-none');

    try{
      const base = "{% url 'followups_devedor_json' 0 %}";
      const url = base.replace('/0/', `/${devedorId}/`) + `?limit=${limit}`;
      const res = await fetch(url, { headers: { 'X-Requested-With': 'fetch' }});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      fuList.innerHTML = '';
      if (!data.items || !data.items.length){
        fuEmpty.classList.remove('d-none');
      } else {
        const frag = document.createDocumentFragment();
        data.items.forEach(it => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.innerHTML = `<p class="mb-1"><strong>${escapeHTML(it.created_at)}:</strong></p><div style="white-space:pre-wrap">${escapeHTML(it.texto)}</div>`;
          frag.appendChild(li);
        });
        fuList.appendChild(frag);
        fuList.classList.remove('d-none');

        // Mostra "ver mais" quando bate no limite atual
        if (data.items.length >= limit) {
          fuVerMais.classList.remove('d-none');
        }
      }
    } catch(e){
      fuEmpty.textContent = 'Falha ao carregar os follow-ups.';
      fuEmpty.classList.remove('d-none');
    } finally {
      fuLoading.classList.add('d-none');
    }
  }

  modal.addEventListener('show.bs.modal', (ev) => {
    const btn = ev.relatedTarget;
    currentDevedor = btn?.getAttribute('data-devedor');
    currentLimit = 50;

    const nome = btn?.getAttribute('data-nome') || 'Follow-ups';
    document.getElementById('modalFollowUpsLabel').textContent = `Follow-ups — ${nome}`;

    if (currentDevedor) {
      loadFollowUps(currentDevedor, currentLimit);
    } else {
      fuLoading.classList.add('d-none');
      fuEmpty.textContent = 'Devedor não identificado.';
      fuEmpty.classList.remove('d-none');
    }
  });

  fuVerMais.addEventListener('click', () => {
    currentLimit += 100;
    if (currentDevedor) loadFollowUps(currentDevedor, currentLimit);
  });
})();
</script>

{% endblock %}

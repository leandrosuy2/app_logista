{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Detalhes do Devedor</h1>

    <!-- Exibição de Mensagens -->
    {% if messages %}
    <div class="mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Informações do Devedor -->
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h3>Informações do Devedor</h3>
        </div>
        <div class="card-body">
            <form method="post" action="">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label><strong>Nome:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.nome }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>CPF:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.cpf }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>CNPJ:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.cnpj }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>Nome da Mãe:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.nome_mae }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>RG:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.rg }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>Observação:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.observacao }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>CEP:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.cep }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>Endereço:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.endereco }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>Bairro:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.bairro }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>Cidade:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.cidade }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>UF:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.uf }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>E-mail 1:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.email1 }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label><strong>E-mail 2:</strong></label>
                        <p class="form-control-plaintext">{{ devedor.email2 }}</p>
                    </div>
                </div>

                <!-- Telefones -->
                <h4 class="mt-4">Telefones</h4>
                <div class="row">
					{% for telefone in telefones %}
					<div class="col-md-4 mb-3">
						<label for="telefone{{ forloop.counter }}"><strong>Telefone {{ forloop.counter }}:</strong></label>
						<input type="text" class="form-control" id="telefone{{ forloop.counter }}" 
							   name="telefone{{ forloop.counter }}" value="{{ telefone }}">
							
						</div>
					{% endfor %}
				</div>



                <button type="submit" class="btn btn-primary w-100">Salvar Alterações</button>
            </form>
        </div>
    </div>




    <!-- Títulos Relacionados -->
    <h2 class="text-center mt-4">Títulos Associados</h2>
	<!-- Entradas -->
    {% if titulos_entrada %}
        <h2 class="text-center mt-4">Entrada</h2>
        <table class="table table-striped table-bordered text-center table-sm" style="font-size: 0.9rem;">
            <thead class="table-dark text-center">
                <tr>
                    <th>Empresa</th>
                    <th>Devedor</th>
                    <th>Título</th>
					<th>Valor Divida</th>
                    <th>Valor Recebido</th>
					<th>Forma Pagamento</th>
					<th>Data baixa</th>
                    <th>Vencimento</th>
					<th>Status</th>
					<th>Juros</th>
					<th>Dias Atraso</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for titulo in titulos_entrada %}
                    <tr>
                        <td>{{ empresa.razao_social }}</td>
                        <td>{{ devedor.nome }}</td>
                        <td>{{ titulo.num_titulo }}</td>
						<td>R$ {{ titulo.valor|floatformat:2 }}</td>
                        <td>R$ {{ titulo.valorRecebido|floatformat:2 }}</td>
						<td>{{ forma_pagamento_map|get_dict_value:titulo.forma_pag_Id }}</td>

						<td>{{ titulo.data_baixa|date:"d/m/Y" }}</td>
                        <td>{{ titulo.dataVencimento|date:"d/m/Y" }}</td>
						<td>
                            {% if titulo.statusBaixa == 0 %}
                                <span class="badge bg-warning text-dark">Pendente</span>
                            {% elif titulo.statusBaixa == 2 %}
                                <span class="badge bg-success">Quitado</span>
                            {% elif titulo.statusBaixa == 3 %}
                                <span class="badge bg-info text-dark">Negociado</span>
                            {% endif %}
                        </td>
						<td>R$ {{ titulo.juros|floatformat:2 }}</td>
						<td> {{ titulo.dias_atraso }}</td>
                        <td>				
						
							{% if titulo.statusBaixa == 0 or titulo.statusBaixa is none %}
											<a href="{% url 'realizar_acordo' titulo.id %}" class="btn btn-sm btn-success">
												<i class="fas fa-handshake"></i> Gerar Acordo
											</a>
											<a href="{% url 'realizar_baixa' titulo.id %}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-download"></i> Baixar
                                </a>
						   {% endif %}
                            {% if titulo.statusBaixa == 3 %}
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalQuitar{{ titulo.id }}">
                                    <i class="fas fa-check"></i> Quitar
                                </button>
                            {% endif %}
							{% if titulo.statusBaixa == 2 %}
							<a href="{% url 'gerar_recibo' titulo.id %}" target="_blank" class="btn btn-sm btn-info">
								<i class="fas fa-file-pdf"></i> Gerar Recibo
							</a>
						{% endif %}
                        </td>
                    </tr>
                    <!-- Modal para Quitar Entrada -->
<div class="modal fade" id="modalQuitar{{ titulo.id }}" tabindex="-1" aria-labelledby="modalQuitarLabel{{ titulo.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'quitar_parcela' titulo.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalQuitarLabel{{ titulo.id }}">Quitar Entrada</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Título:</strong> {{ titulo.num_titulo }}</p>
                    <p><strong>Valor a Quitar:</strong> R$ {{ titulo.valor_recebido|floatformat:2 }}</p>
                    <p><strong>Vencimento:</strong> {{ titulo.data_vencimento|date:"d/m/Y" }}</p>
                    <p><strong>Devedor:</strong> {{ titulo.devedor_nome }}</p>
                    <div class="mb-3">
                        <label for="valorRecebido{{ titulo.id }}" class="form-label">Valor Recebido:</label>
                        <!-- Exibir `titulo.valorRecebido` como valor inicial -->
                        <input type="number" step="0.01" class="form-control" id="valorRecebido{{ titulo.id }}" name="valorRecebido"
                               value="{{ titulo.valor_recebido|floatformat:2 }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="dataBaixa{{ titulo.id }}" class="form-label">Data de Baixa:</label>
                        <input type="date" class="form-control" id="dataBaixa{{ titulo.id }}" name="dataBaixa" required>
                    </div>
                    <div class="mb-3">
                        <label for="formaPagamento{{ titulo.id }}" class="form-label">Forma de Pagamento:</label>
                        <select class="form-select" id="formaPagamento{{ titulo.id }}" name="formaPagamento" required>
                            <option value="0">Pix</option>
                            <option value="1">Dinheiro</option>
                            <option value="2">Cartão de Débito</option>
                            <option value="3">Cartão de Crédito</option>
                            <option value="4">Cheque</option>
                            <option value="5">Depósito em Conta</option>
                            <option value="6">Pagamento na Loja</option>
                            <option value="7">Boleto Bancário</option>
                            <option value="8">Duplicata</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar Quitação</button>
                </div>
            </form>
        </div>
    </div>
</div>

                {% endfor %}
            </tbody>
        </table>
    {% endif %}
<table class="table table-striped table-bordered text-center table-sm" style="font-size: 0.9rem;">
    <thead class="table-dark text-center">
        <tr>
            <th>Empresa</th>
            <th>Devedor</th>
            <th>Título</th>
            <th>Valor Recebido</th>
            <th>Total & Parcela</th>
            <th>Forma de Pagamento</th>
            <th>Vencimento</th>
            <th>Data de Baixa</th>
			<th>Juros</th>
			<th>Dias de atraso</th>
            <th>Status</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody>
        {% if titulos %}
            {% for titulo in titulos_associados %}
			
                <tr style="{% if titulo.statusBaixa == 3 and titulo.dataVencimento < today %}background-color: #FFA500; color: #000;{% endif %}">
                    <td>{{ empresa.razao_social|default:"N/A" }}</td>
                    <td>{{ devedor.nome }}</td>
                    <td>{{ titulo.num_titulo }}</td>
                    <td>R$ {{ titulo.valorRecebido|floatformat:2 }}</td>
                    <td>R$ {{ titulo.valor|floatformat:2 }}</td>
                    <td>{{ forma_pagamento_map|get_dict_value:titulo.forma_pag_Id }}</td>
                    <td>{{ titulo.dataVencimento|date:"d/m/Y" }}</td>
                    <td>
                        {% if titulo.data_baixa %}
                            {{ titulo.data_baixa|date:"d/m/Y" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
					<td>R$ {{ titulo.juros|floatformat:2 }}</td>
					<td>{{ titulo.dias_atraso }}</td>
                    <td>
					
                        {% if titulo.statusBaixa == 0 or titulo.statusBaixa == None %}    
						<span class="badge bg-warning text-dark">Pendente</span>
                        {% elif titulo.statusBaixa == 2 %}
                            <span class="badge bg-success">Quitado</span>
                        {% elif titulo.statusBaixa == 3 %}
                            <span class="badge bg-info text-dark">Negociado</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if titulo.statusBaixa == 3 %}
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalQuitar{{ titulo.id }}">
                                <i class="fas fa-check"></i> Quitar
                            </button>
                        {% endif %}
                        {% if titulo.statusBaixa == 2 %}
                            <a href="{% url 'gerar_recibo' titulo.id %}" target="_blank" class="btn btn-sm btn-info">
                                <i class="fas fa-file-pdf"></i> Gerar Recibo
                            </a>
                        {% endif %}
                        {% if titulo.statusBaixa == 0 or titulo.statusBaixa is none %}
                            <a href="{% url 'realizar_acordo' titulo.id %}" class="btn btn-sm btn-success">
                                <i class="fas fa-handshake"></i> Gerar Acordo
                            </a>
							<a href="{% url 'realizar_baixa' titulo.id %}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-download"></i> Baixar
                                </a>
                        {% endif %}
                    </td>
                </tr>

                <!-- Modal para Quitar Parcelas -->
                <div class="modal fade" id="modalQuitar{{ titulo.id }}" tabindex="-1" aria-labelledby="modalQuitarLabel{{ titulo.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form 
                                method="POST" 
                                action="{% url 'quitar_parcela' titulo.id %}" 
                                onsubmit="return validarValorRecebido({{ titulo.id }}, {{ titulo.valor|floatformat:2 }});">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalQuitarLabel{{ titulo.id }}">Quitar Parcela</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Título:</strong> {{ titulo.num_titulo }}</p>
                                    <p><strong>Valor a Quitar:</strong> R$ {{ titulo.valor|floatformat:2 }}</p>
                                    <p><strong>Vencimento:</strong> {{ titulo.dataVencimento|date:"d/m/Y" }}</p>
                                    <p><strong>Devedor:</strong> {{ titulo.devedor.nome }}</p>
                                    <div class="mb-3">
                                        <label for="valorRecebido{{ titulo.id }}" class="form-label">Valor Recebido:</label>
                                        <input 
                                            type="number" 
                                            step="0.01" 
                                            class="form-control" 
                                            id="valorRecebido{{ titulo.id }}" 
                                            name="valorRecebido"
                                            value="{{ titulo.valor|floatformat:2 }}" 
                                            required>
                                        <div id="erroValorRecebido{{ titulo.id }}" class="text-danger mt-2" style="display: none;">
                                            O valor recebido não pode ser menor que o valor total do título.
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="dataBaixa{{ titulo.id }}" class="form-label">Data de Baixa:</label>
                                        <input type="date" class="form-control" id="dataBaixa{{ titulo.id }}" name="dataBaixa" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="formaPagamento{{ titulo.id }}" class="form-label">Forma de Pagamento:</label>
                                        <select class="form-select" id="formaPagamento{{ titulo.id }}" name="formaPagamento" required>
                                            <option value="0">Pix</option>
                                            <option value="1">Dinheiro</option>
                                            <option value="2">Cartão de Débito</option>
                                            <option value="3">Cartão de Crédito</option>
                                            <option value="4">Cheque</option>
                                            <option value="5">Depósito em Conta</option>
                                            <option value="6">Pagamento na Loja</option>
                                            <option value="7">Boleto Bancário</option>
                                            <option value="8">Duplicata</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">Confirmar Quitação</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            {% endfor %}
        {% else %}
            <tr>
                <td colspan="10">Nenhum título encontrado para esta empresa.</td>
            </tr>
        {% endif %}
    </tbody>
</table>

<script>
    function validarValorRecebido(tituloId, valorMinimo) {
        const inputValorRecebido = document.getElementById(`valorRecebido${tituloId}`);
        const erroValorRecebido = document.getElementById(`erroValorRecebido${tituloId}`);

        if (parseFloat(inputValorRecebido.value) < valorMinimo) {
            erroValorRecebido.style.display = 'block';
            return false; // Impede o envio do formulário
        }

        erroValorRecebido.style.display = 'none';
        return true; // Permite o envio do formulário
    }
</script>


    <!-- Empresa Credora -->
    <div class="card mt-4">
        <div class="card-header bg-warning text-dark">
            <h3>Empresa Credora</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label><strong>Razão Social:</strong></label>
                    <p class="form-control-plaintext">{{ empresa.razao_social }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label><strong>Nome Fantasia:</strong></label>
                    <p class="form-control-plaintext">{{ empresa.nome_fantasia }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label><strong>CNPJ:</strong></label>
                    <p class="form-control-plaintext">{{ empresa.cnpj }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label><strong>Telefone:</strong></label>
                    <p class="form-control-plaintext">{{ empresa.telefone }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label><strong>E-mail:</strong></label>
                    <p class="form-control-plaintext">{{ empresa.email }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label><strong>Endereço:</strong></label>
                    <p class="form-control-plaintext">{{ empresa.endereco }}, {{ empresa.numero }}</p>
                </div>
				<div class="col-md-6 mb-3">
                    <label><strong>Bairro:</strong></label>
                    <p class="form-control-plaintext">{{ empresa.bairro }}</p>
                </div>
				<div class="col-md-6 mb-3">
                    <label><strong>UF:</strong></label>
                    <p class="form-control-plaintext">{{ empresa.uf }}</p>
                </div>
				<div class="col-md-6 mb-3">
                    <label><strong>Cidade:</strong></label>
                    <p class="form-control-plaintext">{{ empresa.cidade }}</p>
                </div>
				<div class="col-md-6 mb-3">
                    <label><strong>Chave pix:</strong></label>
                    <p class="form-control-plaintext">{{ empresa.banco }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Agendamentos -->
	
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h3>Agendamentos</h3>
			 <a href="{% url 'criar_agendamento' %}?devedor_id={{ devedor.id }}" class="btn btn-primary">Criar Novo Agendamento</a>

        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Data de Abertura</th>
                        <th>Data de Retorno</th>
                        <th>Assunto</th>
                        <th>Operador</th>
                        <th>Status</th>
                        <th>Telefone</th>
                    </tr>
                </thead>
                <tbody>
                    {% for agendamento in agendamentos %}
                    <tr>
                        <td>{{ agendamento.data_abertura|date:"d/m/Y H:i" }}</td>
                        <td>{{ agendamento.data_retorno|date:"d/m/Y H:i" }}</td>
                        <td>{{ agendamento.assunto }}</td>
                        <td>{{ agendamento.operador }}</td>
                        <td>{{ agendamento.get_status_display }}</td>
                        <td>
							{{ agendamento.telefone }}
							<a href="https://wa.me/55{{ agendamento.telefone|clean_phone_number }}" 
							   target="_blank" class="btn btn-success btn-sm ms-2" title="Abrir no WhatsApp">
								<i class="bi bi-whatsapp"></i> WhatsApp
							</a>
						</td>




                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Follow-ups -->
<div class="card mt-4">
    <div class="card-header bg-secondary text-white">
        <h3>Follow-ups</h3>
    </div>
    <div class="card-body">
        <!-- Formulário para adicionar Follow-up, comentado pois o lojista não adicionará
follow-ups		
			
	  <form method="post" action="{% url 'adicionar_follow_up' devedor.id %}">
            {% csrf_token %}
            <div class="mb-3">
                <label for="texto" class="form-label"><strong>Novo Follow-up:</strong></label>
                <textarea id="texto" name="texto" class="form-control" rows="3" placeholder="Digite aqui o histórico do WhatsApp ou informações relevantes."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Adicionar Follow-up</button>
        </form>
-->
        <!-- Listagem de Follow-ups -->
        <h4 class="mt-4">Histórico</h4>
        <ul class="list-group">
            {% for follow_up in follow_ups %}
                <li class="list-group-item">
                    <p class="mb-1"><strong>{{ follow_up.created_at|date:"d/m/Y H:i" }}:</strong> {{ follow_up.texto }}</p>
                </li>
            {% empty %}
                <li class="list-group-item">Nenhum Follow-up registrado.</li>
            {% endfor %}
        </ul>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const preSelecionado = {{ pre_selecionado|default:"null"|safe }};

        if (preSelecionado) {
            document.getElementById('devedor_id').value = preSelecionado.id;
            document.getElementById('empresa_id').value = preSelecionado.empresa_id || '';
            document.getElementById('empresa_nome_fantasia').value = preSelecionado.nome_fantasia || 'N/A';
            document.getElementById('telefone').value = preSelecionado.telefone || '';
            document.getElementById('pesquisa_devedor').value = preSelecionado.nome;
        }
    });
</script>

{% endblock %}

{% extends 'base.html' %}

{% block content %}
<style>
  .report-container{max-width:1400px;padding:1.25rem 1rem}
  .header-row{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:0.75rem;margin-bottom:1rem}
  .report-title{font-size:1rem;font-weight:600;color:#2d3748;display:flex;align-items:center;gap:0.5rem;margin:0}
  .action-row{display:flex;flex-wrap:wrap;gap:0.5rem}
  .btn{display:inline-flex;align-items:center;gap:0.35rem;font-weight:600;border-radius:4px;border:none;padding:0.45rem 0.85rem;font-size:0.85rem;text-decoration:none}
  .btn-primary{background:#007bff;color:#fff}
  .btn-primary:hover{background:#0056b3;color:#fff}
  .btn-success{background:#28a745;color:#fff}
  .btn-success:hover{background:#218838;color:#fff}
  .btn-outline{background:#fff;color:#495057;border:1px solid #dee2e6}
  .btn-outline:hover{background:#f8f9fa}
  .filter-card{background:#fff;border:1px solid #dee2e6;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:1rem;margin-bottom:1rem}
  .filter-row{display:flex;flex-wrap:wrap;gap:0.75rem}
  .filter-group{flex:1 1 240px;min-width:200px}
  .filter-group label{font-size:0.78rem;color:#495057;margin-bottom:0.3rem;display:block}
  .filter-group input,.filter-group select{width:100%;border:1px solid #dee2e6;border-radius:4px;padding:0.45rem 0.6rem;font-size:0.85rem}
  .filter-actions{display:flex;align-items:flex-end;gap:0.5rem}
  .summary-row{display:flex;flex-wrap:wrap;gap:0.75rem;margin:1rem 0}
  .summary-card{flex:1 1 180px;min-width:180px;background:#fff;border:1px solid #dee2e6;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:0.8rem}
  .summary-card .label{font-size:0.72rem;color:#6c757d;text-transform:uppercase;letter-spacing:0.3px}
  .summary-card .value{font-size:1rem;font-weight:700;color:#212529;margin-top:0.25rem}
  .table-container{background:#fff;border:1px solid #dee2e6;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.06);overflow:hidden;margin-top:1rem}
  .table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{width:100%;min-width:760px}
  thead{background:#495057;color:#fff}
  th,td{white-space:nowrap;padding:0.55rem 0.75rem;font-size:0.8rem;border:none}
  tbody tr{border-bottom:1px solid #f1f3f5}
  tbody tr:hover{background:#f8f9fa}
  .status-badge{display:inline-flex;align-items:center;justify-content:center;padding:0.25rem 0.55rem;border-radius:999px;font-size:0.7rem;font-weight:600}
  .status-pendente{background:#fff3cd;color:#856404}
  .status-quitado{background:#d4edda;color:#155724}
  .status-negociado{background:#d1ecf1;color:#0c5460}
  .status-desconhecido{background:#e2e3e5;color:#383d41}
  .table-actions{display:flex;flex-wrap:wrap;gap:0.4rem;justify-content:center}
  .btn-xs{padding:0.3rem 0.55rem;font-size:0.75rem;border-radius:4px}
  .pagination{margin:1.25rem 0;display:flex;justify-content:center;flex-wrap:wrap;gap:0.25rem}
  .page-item{list-style:none}
  .page-link{display:inline-block;padding:0.45rem 0.7rem;font-size:0.8rem;font-weight:500;color:#495057;background:#fff;border:1px solid #dee2e6;border-radius:4px;text-decoration:none;min-width:36px;text-align:center}
  .page-item.active .page-link{background:#007bff;color:#fff;border-color:#007bff}
  .page-item.disabled .page-link{opacity:0.6;cursor:default}
  .empty-state{padding:1.25rem;text-align:center;color:#6c757d;font-size:0.85rem}
  .modal-header{background:#f8f9fa}
  @media (max-width:576px){
    .report-container{padding:1rem 0.75rem}
    th,td{padding:0.45rem 0.5rem;font-size:0.75rem}
    table{min-width:640px}
    .filter-group{flex:1 1 100%;min-width:100%}
    .filter-actions{width:100%;justify-content:flex-start}
  }
</style>

<div class="report-container">
  <div class="header-row">
    <h1 class="report-title"><i class="fas fa-users"></i>Lista de Devedores</h1>
    <div class="action-row">
      <a href="{% url 'adicionar_devedor' %}" class="btn btn-success"><i class="fas fa-user-plus"></i>Adicionar devedor</a>
      <a href="{% url 'baixar_modelo_devedor' %}" class="btn btn-outline"><i class="fas fa-file-arrow-down"></i>Baixar modelo</a>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importarModal"><i class="fas fa-file-upload"></i>Importar</button>
    </div>
  </div>

  <form method="get" action="{% url 'listar_devedores' %}" class="filter-card">
    <div class="filter-row">
      <div class="filter-group">
        <label>Buscar devedor</label>
        <input type="text" name="q" value="{{ query }}" placeholder="Nome, CPF, CNPJ, telefone...">
      </div>
      <div class="filter-group">
        <label>Status do título</label>
        <select name="status">
          <option value="">Todos</option>
          {% for option in status_options %}
          <option value="{{ option }}" {% if status == option %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-actions">
        <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Filtrar</button>
        <a href="{% url 'listar_devedores' %}" class="btn btn-outline"><i class="fas fa-eraser"></i> Limpar</a>
      </div>
    </div>
  </form>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="summary-row">
    <div class="summary-card">
      <div class="label">Total devedores</div>
      <div class="value">{{ total_devedores }}</div>
    </div>
    <div class="summary-card">
      <div class="label">Pendentes</div>
      <div class="value">{{ total_pendentes }}</div>
    </div>
    <div class="summary-card">
      <div class="label">Quitados</div>
      <div class="value">{{ total_quitados }}</div>
    </div>
    <div class="summary-card">
      <div class="label">Negociados</div>
      <div class="value">{{ total_negociados }}</div>
    </div>
  </div>

  <div class="table-container">
    <div class="table-wrapper">
      <table class="custom-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Devedor</th>
            <th>Documento</th>
            <th>Empresa</th>
            <th>Títulos</th>
            <th>Status</th>
            <th class="text-center">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% if page_obj and page_obj.object_list %}
            {% for devedor in page_obj.object_list %}
            <tr>
              <td><b>{{ devedor.id }}</b></td>
              <td>
                <div><b>{{ devedor.display_nome }}</b></div>
                {% if devedor.nome_fantasia %}<div class="text-muted" style="font-size:0.72rem;">{{ devedor.nome_fantasia }}</div>{% endif %}
              </td>
              <td><b>
                {% if devedor.cpf %}
                  {{ devedor.cpf }}
                {% elif devedor.cnpj %}
                  {{ devedor.cnpj }}
                {% else %}
                  Não informado
                {% endif %}
              </b></td>
              <td><b>{{ devedor.empresa }}</b></td>
              <td><b>{{ devedor.quantidade_titulos }}</b></td>
              <td>
                {% if devedor.status_baixa == 'Pendente' %}
                  <span class="status-badge status-pendente">Pendente</span>
                {% elif devedor.status_baixa == 'Quitado' %}
                  <span class="status-badge status-quitado">Quitado</span>
                {% elif devedor.status_baixa == 'Negociado' %}
                  <span class="status-badge status-negociado">Negociado</span>
                {% else %}
                  <span class="status-badge status-desconhecido">Desconhecido</span>
                {% endif %}
              </td>
              <td>
                <div class="table-actions">
                  <a href="{% url 'editar_devedor' devedor.id %}" class="btn btn-primary btn-xs"><i class="fas fa-eye"></i> Detalhes</a>
                  <a href="{% url 'listar_titulos_por_devedor' devedor.id %}" class="btn btn-outline btn-xs"><i class="fas fa-list"></i> Títulos</a>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="empty-state">Nenhum devedor encontrado para os filtros informados.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <nav aria-label="Paginação de devedores">
    <ul class="pagination">
      {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ query }}&status={{ status }}"><i class="fas fa-chevron-left"></i> <span class="d-none d-sm-inline">Anterior</span></a></li>
      {% else %}
      <li class="page-item disabled"><span class="page-link"><i class="fas fa-chevron-left"></i> <span class="d-none d-sm-inline">Anterior</span></span></li>
      {% endif %}

      {% if page_obj.paginator.num_pages <= 7 %}
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% else %}
          <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ query }}&status={{ status }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}
      {% else %}
        {% if page_obj.number > 3 %}
        <li class="page-item"><a class="page-link" href="?page=1&q={{ query }}&status={{ status }}">1</a></li>
        {% if page_obj.number > 4 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
          {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ query }}&status={{ status }}">{{ num }}</a></li>
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
        {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ query }}&status={{ status }}">{{ page_obj.paginator.num_pages }}</a></li>
        {% endif %}
      {% endif %}

      {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ query }}&status={{ status }}"><span class="d-none d-sm-inline">Próxima</span> <i class="fas fa-chevron-right"></i></a></li>
      {% else %}
      <li class="page-item disabled"><span class="page-link"><span class="d-none d-sm-inline">Próxima</span> <i class="fas fa-chevron-right"></i></span></li>
      {% endif %}
    </ul>
  </nav>
</div>

<!-- Modal de Importação -->
<div class="modal fade" id="importarModal" tabindex="-1" aria-labelledby="importarModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{% url 'importar_devedor' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importarModalLabel">Importar devedores</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="arquivo" class="form-label">Selecione a planilha</label>
          <input type="file" name="arquivo" id="arquivo" class="form-control" required>
          <div class="form-text mt-2">Utilize o modelo oficial para garantir a importação correta.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Importar</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}
